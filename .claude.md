# Nova S2S VoIP Gateway - Claude Context

## Project Overview
This is a SIP-based VoIP gateway that bridges traditional phone calls to Amazon Nova Sonic (speech-to-speech AI). Users can call a phone number and have real-time conversations with Nova Sonic AI.

## Technology Stack
- **Backend**: Java 9+ with Maven
- **SIP Library**: mjSIP 2.0.5 (GPLv2 licensed)
- **AI Integration**: Amazon Bedrock Nova Sonic
- **Infrastructure**: AWS CDK (TypeScript)
- **Deployment**: EC2 or ECS (Docker)

## Architecture
```
Phone Call → SIP Server → This Gateway (SIP+RTP) ↔ Amazon Nova Sonic → Response via RTP
```

The gateway:
1. Registers with a SIP server (or runs in trunk mode)
2. Answers incoming calls
3. Establishes RTP media sessions
4. Bridges audio between RTP (phone) and Nova Sonic in real-time
5. Transcodes between μ-law (phone) and PCM (Nova)

## Project Structure
```
mjsip-s2s-voip-gateway/
├── src/main/java/com/example/s2s/voipgateway/
│   ├── NovaSonicVoipGateway.java          # Main entry point
│   ├── NovaMediaConfig.java                # Media configuration
│   ├── nova/
│   │   ├── NovaStreamerFactory.java        # Creates Nova media streamers
│   │   ├── NovaS2SBedrockInteractClient.java  # Bedrock client
│   │   ├── NovaS2SResponseHandler.java     # Response handling
│   │   ├── io/                             # Audio I/O streams
│   │   ├── transcode/                      # Audio transcoding (μ-law ↔ PCM)
│   │   └── tools/                          # Nova tools (e.g., DateTime)
│   └── constants/                          # Audio constants
├── cdk-ec2-instance/                       # EC2 deployment stack
│   ├── bin/cdk.ts                          # CDK app entry
│   └── lib/cdk-stack.ts                    # EC2 stack definition
├── cdk-ecs/                                # ECS deployment stack
│   ├── bin/cdk-ecs.ts                      # CDK app entry
│   └── lib/cdk-ecs-stack.ts               # ECS stack definition
├── docker/                                 # Docker image for ECS
├── deploy-to-ec2.sh                        # Build & deploy script
├── setup-service.sh                        # Service setup script
├── nova-voip-gateway.service               # Systemd service file
└── pom.xml                                 # Maven configuration
```

## Key Configuration Files

### Environment Variables (environment file)
```bash
SIP_SERVER=          # SIP server hostname/IP
SIP_USER=            # SIP username
AUTH_USER=           # Auth username
AUTH_PASSWORD=       # Auth password
AUTH_REALM=          # SIP realm
DISPLAY_NAME=        # Display name
DO_REGISTER=false    # Set to false for trunk mode (inbound only)
MEDIA_PORT_BASE=10000
MEDIA_PORT_COUNT=10000
NOVA_VOICE_ID=en_us_matthew  # Nova voice
NOVA_PROMPT=         # Custom prompt (optional)
```

### .mjsip-ua Configuration File
Alternative to environment variables. See `.mjsip-ua.template` or `.mjsip-ua-trunk.template`.

## Deployment Options

### Option 1: EC2 Instance (Recommended for Development)
- Simple single instance deployment
- Direct access for testing
- Lower cost
- Manual service management

**Deploy:**
```bash
cd cdk-ec2-instance
npm install
cdk deploy
./deploy-to-ec2.sh      # Build and copy JAR
./setup-service.sh       # Setup as systemd service
```

### Option 2: ECS with EC2 (Production)
- Container-based deployment
- Host network mode (required for UDP port ranges)
- Automatic restarts
- Docker image pushed to ECR

**Deploy:**
```bash
cd cdk-ecs
npm install
# Edit cdk.context.json with SIP credentials
cdk deploy
```

## Current Deployment (EC2)

### Instance Details
- **Elastic IP**: 35.155.30.129
- **Region**: us-west-2
- **Instance Type**: t3.micro
- **Keypair**: mjsip_s2s_gateway

### Security Group Rules (Locked Down)
- **UDP 5060** (SIP): From 99.77.253.0/24 (Chime Voice Connector only)
- **TCP 5060** (SIP): From 99.77.253.0/24 (Chime Voice Connector only)
- **UDP 10000-20000** (RTP): From 99.77.253.0/24 (Chime Voice Connector only)
- **TCP 22** (SSH): From anywhere (consider restricting)

### Systemd Service
- **Service Name**: nova-voip-gateway
- **Status**: `sudo systemctl status nova-voip-gateway`
- **Logs**: `sudo journalctl -u nova-voip-gateway -f`
- **Restart**: `sudo systemctl restart nova-voip-gateway`
- **Config**: `/home/ec2-user/mjsip-s2s-voip-gateway/.mjsip-ua`

## Network Requirements
- **Inbound UDP 5060**: SIP signaling
- **Inbound UDP 10000-20000**: RTP media (configurable via MEDIA_PORT_BASE/COUNT)
- **Outbound HTTPS**: AWS Bedrock API access
- **Public IP**: Required (NAT/STUN/ICE not supported by mjSIP)

## Trunk Mode (Inbound Only)
Current configuration runs in **trunk mode**:
- No SIP registration
- Only accepts inbound calls
- SIP server routes calls directly to gateway's IP
- Requires `DO_REGISTER=false` or `do_register=no` in config

## Phone Number Filtering
The gateway can filter incoming calls by destination number:

**Configuration File:** `src/main/resources/accepted-numbers.properties`

```properties
# Accepted phone numbers for incoming calls
# Format: One number per line, with or without country code
# Lines starting with # are comments

4432304260
# Add more numbers here
```

**Behavior:**
- Numbers are automatically normalized (removes +, spaces, etc.)
- Matches variations: `4432304260`, `14432304260`, `+14432304260`
- If file is empty or missing, accepts all calls
- Rejected calls receive a hangup (SIP BYE)
- All call attempts are logged

**To add/modify numbers:**
1. Edit `src/main/resources/accepted-numbers.properties`
2. Rebuild: `mvn clean package`
3. Deploy: `./deploy-to-ec2.sh`
4. Restart service: `sudo systemctl restart nova-voip-gateway`

## Maven Setup
Requires GitHub Personal Access Token for mjSIP dependency:

`~/.m2/settings.xml`:
```xml
<servers>
  <server>
    <id>github</id>
    <username>YOUR_USERNAME</username>
    <password>YOUR_GITHUB_TOKEN</password>
  </server>
</servers>
```

## Build Commands
```bash
# Build JAR
mvn clean package

# Run locally
./run.sh

# Deploy to EC2
./deploy-to-ec2.sh

# Setup service
./setup-service.sh
```

## Code Patterns

### Adding New Tools for Nova (Modular Auto-Discovery System)

The project uses a **modular, auto-discovery tool system**. Tools are automatically discovered at runtime.

**To add a new tool:**
1. Create a class implementing `Tool` interface in `src/main/java/com/example/s2s/voipgateway/nova/tools/`
2. Implement 4 methods: `getName()`, `getDescription()`, `getInputSchema()`, `handle()`
3. That's it! No manual registration needed.

**Available Tools:**
- `DateTimeTool` - Get current date/time
- `GetCallerPhoneTool` - Get caller's phone number
- `SendOTPTool` - Send OTP via SMS (AWS Pinpoint)
- `VerifyOTPTool` - Verify OTP codes
- `HangupTool` - End call
- `SendSMSTool` - Send SMS (AWS Pinpoint)
- `CollectAddressTool` - Collect address info
- `AddressValidationTool` - Validate addresses

**Dependency Injection:**
ToolFactory automatically injects dependencies based on constructor:
- `String` → Caller's phone number
- `PinpointClient` → AWS Pinpoint for SMS
- `Map<String, String>` → Shared OTP store

**Example:**
```java
public class MyTool implements Tool {
    public String getName() { return "myTool"; }
    public String getDescription() { return "What it does"; }
    public Map<String, String> getInputSchema() { return ToolSpecs.DEFAULT_TOOL_SPEC; }
    public void handle(String toolUseId, String content, Map<String, Object> output) {
        output.put("status", "success");
    }
}
```

See `src/main/java/com/example/s2s/voipgateway/nova/tools/README.md` for full documentation.

### Environment vs .mjsip-ua Configuration
- If `SIP_SERVER` env var is set → uses environment variables
- Otherwise → reads from `.mjsip-ua` file
- Service setup uses `.mjsip-ua` file approach

## Common Tasks

### Update SIP Credentials
```bash
ssh -i /Users/yasser/Downloads/mjsip_s2s_gateway.pem ec2-user@35.155.30.129
nano /home/ec2-user/mjsip-s2s-voip-gateway/.mjsip-ua
sudo systemctl restart nova-voip-gateway
```

### Redeploy After Code Changes
```bash
./deploy-to-ec2.sh
ssh -i /Users/yasser/Downloads/mjsip_s2s_gateway.pem ec2-user@35.155.30.129
sudo systemctl restart nova-voip-gateway
```

### View Logs
```bash
ssh -i /Users/yasser/Downloads/mjsip_s2s_gateway.pem ec2-user@35.155.30.129
sudo journalctl -u nova-voip-gateway -f
```

### Update Security Group
Edit `cdk-ec2-instance/lib/cdk-stack.ts`, then:
```bash
cd cdk-ec2-instance
cdk deploy --require-approval never
```

## Important Notes
- **mjSIP Limitations**: No uPNP, ICE, or STUN support - requires public IP
- **Audio Codec**: Uses PCMU (μ-law) @ 8kHz for RTP
- **Nova Integration**: Uses Bedrock Runtime API with streaming
- **Service Account**: Runs as `ec2-user` (not root)
- **Java Version**: Compiled for Java 9, runs on Amazon Corretto 24
- **IAM Permissions**: EC2 instance needs Bedrock access via IAM role

## Troubleshooting

### SIP Registration Fails
- Check `registrar`, `auth_user`, `auth_realm`, `auth_passwd` in config
- Verify network connectivity to SIP server
- Check logs: `sudo journalctl -u nova-voip-gateway -f`

### No Audio / RTP Issues
- Verify security group allows UDP 10000-20000
- Check `via-addr` matches public IP (35.155.30.129)
- Confirm SIP server can route to gateway IP

### Bedrock Access Denied
- Verify IAM role attached to EC2 instance
- Check role has `bedrock:InvokeModel` permission
- Ensure Nova Sonic is enabled in us-west-2

### Service Won't Start
- Check Java is installed: `java -version`
- Verify JAR exists: `ls -l /home/ec2-user/mjsip-s2s-voip-gateway/*.jar`
- Check config file: `cat /home/ec2-user/mjsip-s2s-voip-gateway/.mjsip-ua`
- Review logs: `sudo journalctl -u nova-voip-gateway -xe`

## License
MIT-0 (Amazon code) + GPLv2 (mjSIP dependency)

## Related AWS Services
- **Amazon Bedrock**: Nova Sonic speech-to-speech model
- **Amazon Chime SDK Voice Connector**: SIP trunking (current integration)
- **Amazon EC2**: Compute hosting
- **Amazon CloudWatch**: Logs (via systemd journal)
